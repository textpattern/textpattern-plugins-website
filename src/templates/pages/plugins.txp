<!DOCTYPE html>
<html lang="en-GB-oxendict">
<head>
    <txp:output_form form="head" />
    <txp:if_article_list>
        <txp:article pgonly limit="12" />
        <title>Plugins list / Textpattern CMS plugins</title>
        <meta name="description" content="Alphabetical list of plugins available for Textpattern CMS, with direct download links and further usage information.">
        <txp:variable name="page" value='<txp:page_url type="pg" />' />
        <txp:if_variable name="page" value="1">
            <meta name="robots" content="index, follow">
            <link rel="canonical" href="<txp:site_url />plugins/">
            <meta name="twitter:card" content="summary">
            <meta name="twitter:site" content="@textpattern">
            <meta name="twitter:title" content="Plugins list">
            <meta name="twitter:description" content="Alphabetical list of plugins available for Textpattern CMS, with direct download links and further usage information.">
            <meta name="twitter:image:src" content="https://textpattern.com/apple-touch-icon-180x180.png">
            <meta name="twitter:url" content="<txp:site_url />plugins/">
            <meta property="og:site_name" content="Textpattern CMS">
            <meta property="og:type" content="website">
            <meta property="og:title" content="Plugins list">
            <meta property="og:description" content="Alphabetical list of plugins available for Textpattern CMS, with direct download links and further usage information.">
            <meta property="og:image" content="https://textpattern.com/assets/img/branding/textpattern/textpattern-og.png">
            <meta property="og:image:width" content="1200">
            <meta property="og:image:height" content="1200">
            <meta property="og:image:alt" content="Textpattern logo">
            <meta property="og:url" content="<txp:site_url />plugins/">
            <script type="application/ld+json">
                {
                    "@context": "https://schema.org",
                    "@type": "CollectionPage",
                    "headline": "Plugins list",
                    "description": "Alphabetical list of plugins available for Textpattern CMS, with direct download links and further usage information.",
                    "url": "<txp:site_url escape="json" />plugins/"
                }
            </script>
        <txp:else />
            <meta name="robots" content="noindex, follow">
        </txp:if_variable>
        <txp:evaluate test>
            <link rel="prev" href="<txp:newer />">
        </txp:evaluate>
        <txp:evaluate test>
            <link rel="next" href="<txp:older />">
        </txp:evaluate>
    <txp:else />
        <txp:output_form form="json_card_reader" />
        <title>Plugin: <txp:title /> / Textpattern CMS plugin</title>
        <txp:meta_description />
        <meta name="robots" content="index, follow">
        <link rel="canonical" href="<txp:permlink />">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@textpattern">
        <meta name="twitter:title" content="Plugin: <txp:title />">
        <meta name="twitter:description" content="<txp:meta_description format="" />">
        <meta name="twitter:url" content="<txp:permlink />">
        <meta property="og:site_name" content="Textpattern CMS plugins">
        <meta property="og:type" content="article">
        <meta property="og:title" content="Plugin: <txp:title />">
        <meta property="og:description" content="<txp:meta_description format="" />">
        <meta property="og:url" content="<txp:permlink />">
        <txp:if_article_image>
            <txp:images limit="1">
                <meta name="twitter:image:src" content="<txp:image_url />">
                <meta property="og:image" content="<txp:image_url />">
                <meta property="og:image:width" content="<txp:image_info type="w" />">
                <meta property="og:image:height" content="<txp:image_info type="h" />">
                <meta property="og:image:alt" content="<txp:image_info type="alt" />">
            </txp:images>
        <txp:else />
            <meta name="twitter:image:src" content="https://textpattern.com/apple-touch-icon-180x180.png">
            <meta property="og:image" content="https://textpattern.com/assets/img/branding/textpattern/textpattern-og.png">
            <meta property="og:image:width" content="1200">
            <meta property="og:image:height" content="1200">
            <meta property="og:image:alt" content="Textpattern logo">
        </txp:if_article_image>
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "ItemPage",
                "headline": "Plugin: <txp:title escape="json" />",
                "description": "<txp:meta_description format="" escape="json" />",
                "url": "<txp:permlink escape="json" />",
                "potentialAction": {
                    "@type": "DownloadAction",
                    "object": {
                        "@type": "SoftwareApplication",
                        "name": "<txp:title escape="json" />",
                        "applicationCategory": "Plugin",
                        "softwareRequirements": "Textpattern CMS",
                        "softwareVersion": "<txp:if_variable name="json-stable-version"><txp:variable name="json-stable-version" /><txp:else /><txp:variable name="json-beta-version" /></txp:if_variable>",
                        "datePublished": "",
                        "downloadUrl": ""
                    }
                }
            }
        </script>
    </txp:if_article_list>
    <txp:variable name="min-txp-version-unverified" value='<txp:category_list type="file" parent="txp-version" exclude="txp-version" limit="1"><txp:category title /></txp:category_list>' />
    <txp:variable name="max-txp-version-unverified" value='<txp:category_list type="file" parent="txp-version" exclude="txp-version" limit="1" sort="name desc"><txp:category title /></txp:category_list>' />
</head>
<txp:if_article_list>
    <body itemscope itemtype="https://schema.org/CollectionPage">
<txp:else />
    <body itemscope itemtype="https://schema.org/ItemPage">
</txp:if_article_list>
    <txp:output_form form="body_header" />
    <main aria-label="Main content">
        <div class="container">
            <txp:output_form form="body_crumbs" />
            <txp:if_article_list>
                <h1 itemprop="name">Plugins list</h1>
                <txp:article form="article_listing" sort="Category2 desc, Title asc" limit="12" wraptag="div" class="layout-container" />
                <txp:output_form form="pagination" />
            <txp:else />
                <div class="layout-container">
                    <article class="layout-4col-3span" itemscope itemtype="https://schema.org/Article">
                        <meta itemprop="mainEntityOfPage" content="<txp:permlink />">
                        <h1 itemprop="headline">Plugin: <txp:title /></h1>
                        <p>
                            By
                            <span itemprop="author" itemscope itemtype="https://schema.org/Person">
                                <txp:article_custom section="authors" author-prefix='<txp:custom_field name="author-prefix" />' limit="1">
                                    <a class="article-author" rel="author" href="<txp:permlink />" itemprop="url"><span itemprop="name"><txp:title /></span></a>
                                </txp:article_custom>
                                <span>(plugin prefix <code itemprop="alternateName"><txp:custom_field name="author-prefix" /></code>)</span>
                            </span>
                        </p>
                        <div class="card-postinfo">
                            <span itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
                                <meta itemprop="name" content="Textpattern CMS">
                                <span itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
                                    <meta itemprop="url" content="https://textpattern.com/assets/img/branding/textpattern/textpattern.png">
                                    <meta itemprop="width" content="320">
                                    <meta itemprop="height" content="60">
                                </span>
                            </span>
                            <span class="separator--passive">Plugin categorization:</span>
                            <span itemprop="keywords">
                                <txp:category1 title link />
                            </span>
                            <br>
                            <span class="separator--passive">Textpattern version compatibility:</span>
                            <span class="inline-block">
                                <txp:if_custom_field name="min-txp-version">
                                    <span class="compatibility"><txp:custom_field name="min-txp-version" /></span>
                                <txp:else />
                                    <span class="compatibility"><txp:variable name="min-txp-version-unverified" /></span><b class="alert-block alert-pill warning">Unverified</b>
                                </txp:if_custom_field>
                                <txp:if_custom_field name="max-txp-version">
                                    <txp:if_custom_field name="min-txp-version" not value='<txp:custom_field name="max-txp-version" />'>
                                        <txp:if_custom_field name="max-txp-version" not value='<txp:variable name="min-txp-version-unverified" />'>
                                            <span role="separator" aria-label="To">→</span>
                                            <span class="compatibility"><txp:custom_field name="max-txp-version" /></span>
                                        </txp:if_custom_field>
                                    </txp:if_custom_field>
                                <txp:else />
                                    <txp:if_custom_field name="min-txp-version" not value='<txp:variable name="max-txp-version-unverified" />'>
                                        <span role="separator" aria-label="To">→</span>
                                        <span class="compatibility"><txp:variable name="max-txp-version-unverified" /></span><b class="alert-block alert-pill warning">Unverified</b>
                                    </txp:if_custom_field>
                                </txp:if_custom_field>
                            </span>
                        </div>
                        <txp:if_excerpt>
                            <div class="article-description" itemprop="description">
                                <h3>Description</h3>
                                <txp:excerpt />
                            </div>
                        </txp:if_excerpt>

<txp:php>
global $variable;

function formatBytes($bytes, $precision = 2) {
    $units = array('B', 'KB', 'MB', 'GB', 'TB');

    $bytes = max($bytes, 0);
    $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
    $pow = min($pow, count($units) - 1);

    $bytes /= pow(1024, $pow);

    return round($bytes, $precision).$units[$pow];
}

$github_url = parse('<txp:custom_field name="github-repo" />');
$github_ident = explode('/', parse_url($github_url, PHP_URL_PATH));

$query = <<<'GRAPHQL'
query($organizationLogin:String!,$repositoryName:String!) {
  repository(owner:$organizationLogin, name:$repositoryName) {
    url
    stargazers {
      totalCount
    }
    object(expression:"master") {
      ... on Commit {
        history {
          totalCount
        }
      }
    }
    releases(first: 10, orderBy: {field:CREATED_AT, direction:DESC}) {
      totalCount
      nodes {
        releaseAssets(last: 5) {
          nodes {
            createdAt
            name
            downloadCount
            createdAt
            downloadUrl
            size
            release {
              tagName
              name
              isPrerelease
              url
            }
          }
        }
      }
    }
    repositoryTopics(last: 10) {
      edges {
        node {
          url
          topic {
            name
          }
        }
      }
    }
    licenseInfo {
        name
        url
    }
    pushedAt
  }
}
GRAPHQL;
$variables = [
    'organizationLogin' => $github_ident[1],
    'repositoryName' => $github_ident[2]
];

$json = json_encode(['query' => $query, 'variables' => $variables]);

$curl = curl_init();

curl_setopt_array($curl, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_URL => 'https://api.github.com/graphql',
    CURLOPT_FAILONERROR => true,
    CURLOPT_POSTFIELDS => $json,
    CURLOPT_HTTPHEADER => array(
        'User-Agent: Textpattern CMS',
        'Content-Type: application/json;charset=utf-8',
        'Authorization: bearer '.$variable['github-api-key']
    ),
]);

$response = curl_exec($curl);

curl_close($curl);

if ($response === false) {
    return; // TODO: maybe show an error message on page?
}

if (!($json = json_decode($response))) {
    return;
}

$json = json_decode($response);

echo '<h3 id="releases">Download releases</h3>';
echo '<p>Total number of releases: '.intval($json->data->repository->releases->totalCount).' <a rel="external" href="'.$json->data->repository->url.'/releases"><span class="ui-icon ui-icon-extlink" title="View all releases on GitHub">View all releases on GitHub</span></a></p>';
echo '<dl class="definitionlist--compact">';

foreach ($json->data->repository->releases->nodes as $releaseElement) {
    echo '<dt>'.htmlspecialchars($releaseElement->releaseAssets->nodes[0]->release->name).
        ' <a rel="external" href="'.$releaseElement->releaseAssets->nodes[0]->release->url.'"><span class="ui-icon ui-icon-extlink" title="View this release on GitHub">View this release on GitHub</span></a>';

    if ($releaseElement->releaseAssets->nodes[0]->release->isPrerelease === true) {
        echo ' <small class="alert-block alert-pill warning">Prerelease</small>';
    }

    echo '</dt>';
    echo '<dd>Release date: <time datetime="'.$releaseElement->releaseAssets->nodes[0]->createdAt.'">'.date("d.m.Y, g:ia", strtotime($releaseElement->releaseAssets->nodes[0]->createdAt)).'</time></dd>';

    foreach ($releaseElement->releaseAssets->nodes as $releaseSubElement) {
        echo '<dd><a href="'.$releaseSubElement->downloadUrl.'" title="Download this file"><span class="ui-icon ui-extra-icon-download"></span> '.htmlspecialchars($releaseSubElement->name).'</a> <small>('.formatBytes($releaseSubElement->size).')</small></dd>';
    }
}

echo '</dl>';
echo '<p class="alert-block information footnote report-issues">If you notice any kind of problem with this page’s construction or content (plugin doesn’t work as stated, outdated information, typos, broken links, or whatever), <a rel="external" target="_blank" href="https://github.com/textpattern/textpattern-plugins-website/issues/new/choose">open an issue</a> and we’ll investigate.</p>';
echo '</article>';
echo '<section class="layout-4col sidebar">';
echo '<h3>General information</h3>';
echo '<a class="button" rel="external" href="'.$json->data->repository->url.'" title="Stars on GitHub"><span class="ui-icon ui-extra-icon-github">GitHub</span> <strong>Stars</strong></a> <a class="count-bubble" rel="external" href="'.$json->data->repository->url.'/stargazers" title="Stargazers on GitHub">'.intval($json->data->repository->stargazers->totalCount).'</a>';
echo '<dl class="definitionlist--compact">';
echo '<dt>Latest repo activity</dt>';
echo '<dd><time datetime="'.$json->data->repository->pushedAt.'">'.date("d.m.Y, g:ia", strtotime($json->data->repository->pushedAt)).'</time>';

if (isset($json->data->repository->object->history->totalCount)) {
    echo '<br>(total commits to master = <a rel="external" href="'.$json->data->repository->url.'/commits" title="View commits to master on GitHub">'.intval($json->data->repository->object->history->totalCount).'</a>)';
}

echo '</dd>';

if (isset($json->data->repository->licenseInfo->name)) {
    echo '<dt>License(s)</dt>';
    echo '<dd><a href="'.$json->data->repository->licenseInfo->url.'">'.htmlspecialchars($json->data->repository->licenseInfo->name).'</a></dd>';
}
</txp:php>
                        </dl>
                        <p><img class="dark-contrast" width="200" height="200" alt="The Plugins Carver" src="/assets/img/plugins-carver.png" srcset="/assets/img/plugins-carver@2x.png 2x"></p>
                    </section>
                </div>
            </txp:if_article_list>
        </div>
    </main>
    <txp:output_form form="body_footer" />
</body>
</html>
